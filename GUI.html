<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helmet Detection Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            /* background-image: url('latar.jpg'); Ganti dengan path gambar Anda */
            /* background: linear-gradient(to top, transparent, white), url('latar.jpg'); */
            background-size: cover; /* Menyesuaikan ukuran gambar dengan layar */
            background-repeat: no-repeat; /* Tidak mengulang gambar */
            background-position: center; /* Memusatkan gambar */
            color: #ffffff;
        }

        .video-background {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            z-index: -1;
        }

        .video-background video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .content {
            position: relative;
            z-index: 1;
            color: rgb(209, 207, 207);
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5); /* Optional: Add a semi-transparent background for text readability */
        }

        .header {
            font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
            font-size: 2rem;
            font-weight: 500;
            letter-spacing: 2px;
            text-align: center;
            color: #f35626;
            background-image: -webkit-linear-gradient(92deg, #f35626, #feab3a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-animation: hue 10s infinite linear;
            padding-bottom: 100px;
        }

        @-webkit-keyframes hue {
            from {
                -webkit-filter: hue-rotate(0deg);
            }
            to {
                -webkit-filter: hue-rotate(-360deg);
            }
        }

        .main-content {
            margin-top: 20px;
            text-align: center;
        }

        .status {
            margin-top: 20px;
            display: flex;
            gap: 10px; /* Jarak antar kotak status */
        }

        .status-box {
            flex: 1; /* Membuat kotak status seimbang */
            padding: 10px;

            color:white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .status-alarm {
            flex: 1; /* Membuat kotak status seimbang */
            padding: 10px;
            font-size: larger;
            color:rgb(240, 18, 18);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: blink 1s linear infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        .prediction {
            margin-top: 20px;
            padding: 10px;
        }

        .prediction p {
            margin: 0;
        }

        .progress {
            height: 20px;
        }

        .progress-bar {
            background-color: rgba(0, 0, 0, 0.9); /* Set background color to black with alpha 0.9 */
        }

        .camera-feed {
            margin: 0 auto;
            text-align: center; /* Memusatkan teks dan konten */
            padding: 20px; /* Memberikan jarak dalam */
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
            background-color: rgba(26, 26, 26, 0.58); 
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); /* Efek bayangan */
            backdrop-filter: blur(10px); /* Efek blur transparansi */
            margin: 0; /* Memberikan jarak antar elemen */
        }

        .camera-feed img {
            width: 100%;
            max-width: 300px;
            border-radius: 15px;
        }

        .logo {
            position: relative;
            top: 0px;
            left: 10px;
            z-index: 0; /* Ensure the logo is above the video but below the content */
        }

        .card {
    width: 300px; /* Atur lebar card sesuai kebutuhan */
    padding: 20px; /* Ruang di dalam card */
    border: 1px solid #ccc; /* Garis batas card */
    border-radius: 10px; /* Sudut melengkung card */
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Bayangan card */
    display: flex; /* Menggunakan flexbox untuk penataan */
    justify-content: center; /* Rata tengah secara horizontal */
    align-items: center; /* Rata tengah secara vertikal */
    text-align: center; /* Rata tengah teks */
}

#label-container {
    margin: 0; /* Menghapus margin default */
    padding: 10px; /* Ruang di dalam label-container */
    font-size: 16px; /* Ukuran font */
    color: #333; /* Warna teks */
}

        .cardinfo {
            background-color: rgba(26, 26, 26, 0.58); 
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;

            padding: 20px; /* Memberikan jarak dalam */
            color: white;
        
            text-align: center !important;
        }

        .card-custom-bg {
            background-color: #25292d85; /* Ganti dengan warna yang Anda inginkan */
            padding: 20px; /* Menambahkan padding jika diperlukan */
        
            border-radius: 10px;
        }

        .card {
            border: none; /* Menghapus border jika diperlukan */
            border-radius: 15px; /* Mengatur radius sudut jika diperlukan */
        }

        #webcam-container {
            width: 100%;
            max-width: 640px;
            border: 1px solid #ccc;
            border-radius: 8px;
            top: 10px;
        }
    </style>
</head>
<body>

    <div class="video-background">
        <video autoplay loop muted playsinline>
            <source src="video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <div class="content">
        <div class="logo">
            <img src="logo.png" alt="Logo" width="200" height="100">
        </div>
    </div>

    <div class="container main-content">
        <div class="container">
            <div class="row" >
                <!-- Card Info (Col-md-8) -->
                <div class="cardinfo col-md-8 text-start">
                    <h2>SELAMAT DATANG</h2>
                    <p>Silahkan berdiri di depan kamera atur posisi anda agar tampak dilayar</p>
                    <div class="status">
                        <div class="status-box">
                            <p><strong>INTERNET</strong>: CONNECTED</p>
                        </div>
                        <div class="status-box">
                            <p><strong>CAMERA</strong>: ACTIVE</p>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success" onclick="init()">
                        Start Camera
                      </button>
                      <button type="button" class="btn btn-success" onclick="captureImage()">
                        Capture Camera
                      </button>

                      

                      <div class="status">
                       
                        <div id="pesan" class="status-alarm" style="display: none;">
                            <p><strong>AKTIFKAN ALARM</strong></p>
                        </div>
                    </div>  
                </div>

                <!-- Camera Feed (Col-md-4) -->
                <div class="col-md-4 camera-feed">
                    <div id="webcam-container"></div>
                    <p id="prediction-result"><strong>CAMERA</strong></p>
                </div>
            </div>
    
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- Kolom 1 -->
            <div class="col-md-4">
                <div class="prediction card-custom-bg p-3">
                    <p>Tidak ada orang <span class="float-end" id="no-person-label">0%</span></p>
                    <div class="progress">
                        <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%;" id="no-person"></div>
                    </div>
                </div>
            </div>
            <!-- Kolom 2 -->
            <div class="col-md-4">
                <div class="prediction card-custom-bg p-3">
                    <p>Tidak Mengenakan Helm <span class="float-end" id="not-wearing-helmet-label">95%</span></p>
                    <div class="progress">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 95%;" id="not-wearing-helmet"></div>
                    </div>
                </div>
            </div>
            <!-- Kolom 3 -->
            <div class="col-md-4">
                <div class="prediction card-custom-bg p-3">
                    <p>Mengenakan Helm <span class="float-end" id="wearing-helmet-label">5%</span></p>
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 5%;" id="wearing-helmet"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="label-container" class="info"></div>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script type="text/javascript">
        const URL = "my_model/";
        let model, webcam, labelContainer, maxPredictions;
        let mqttClient;
        let lastMessage = "";
        const mqttBroker = "broker.emqx.io";
        const mqttTopic = "helm";
        const messageInterval = 1000; // 5 seconds delay
        let lastCapturedTimestamp = null;

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = true;
            webcam = new tmImage.Webcam(380, 300, flip);
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }

            // Initialize MQTT client
            mqttClient = mqtt.connect(`ws://${mqttBroker}:8083/mqtt`);
            mqttClient.on('connect', () => {
                console.log('Connected to MQTT broker');
            });

            mqttClient.on('error', (error) => {
                console.error('MQTT error:', error);
            });
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction =
                    prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;
            }

            const noPersonProb = prediction[0].probability.toFixed(2) * 100;
            const notWearingHelmetProb = prediction[1].probability.toFixed(2) * 100;
            const wearingHelmetProb = prediction[2].probability.toFixed(2) * 100;
          

            document.getElementById("no-person").style.width = `${noPersonProb}%`;
            document.getElementById("no-person-label").innerText = `${noPersonProb}%`;

            document.getElementById("wearing-helmet").style.width = `${wearingHelmetProb}%`;
            document.getElementById("wearing-helmet-label").innerText = `${wearingHelmetProb}%`;

            document.getElementById("not-wearing-helmet").style.width = `${notWearingHelmetProb}%`;
            document.getElementById("not-wearing-helmet-label").innerText = `${notWearingHelmetProb}%`;

            let resultText = "";
            let message = "";
            let showAlarm = true;

            if (noPersonProb > 50) {
                resultText = "TIDAK ADA ORANG";
                message = "Alarm Non Aktif";
                showAlarm = false;
            }
            if (wearingHelmetProb > 50) {
                resultText = "MENGENAKAN HELM";
                message = "Alarm Non Aktif";
                showAlarm = false;
            }
            if (notWearingHelmetProb > 50) {
                resultText = "TIDAK MENGENAKAN HELM";
                message = "Alarm Aktif";
                showAlarm = true;
            }

            document.getElementById("prediction-result").innerHTML = `<strong>${resultText}</strong>`;

            if (message !== lastMessage) {
                lastMessage = message;
                setTimeout(() => {
                    mqttClient.publish(mqttTopic, message);
                    console.log(`Sent MQTT message: ${message}`);
                }, messageInterval);

                document.getElementById("pesan").style.display = showAlarm ? "block" : "none";
            }
          //  captureImage();

            // Capture image if not wearing helmet and no recent capture
            if (notWearingHelmetProb > 50 && lastCapturedTimestamp === null) {
            // if (notWearingHelmetProb > 50) {    
                captureImage();
            }
        }

        function captureImage() {
            const canvas = webcam.canvas;
            const dataURL = canvas.toDataURL('image/jpeg');
            const timestamp = new Date().toISOString().replace(/:/g, '-').replace(/\./g, '-');
            const filename = `${timestamp}.jpg`;
            const filePath = `c:\foto\${filename}`;

            console.log(`Capturing image: ${filePath}`);

            // Create a link element to download the image
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = filename;

            // Trigger the download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            console.log(`Image saved: ${filePath}`);

            // Save the timestamp to avoid redundant captures
            lastCapturedTimestamp = timestamp;

            // Reset the timestamp after a certain period (e.g., 10 seconds)
            setTimeout(() => {
                lastCapturedTimestamp = null;
            }, 10000);
        }
    </script>
</body>
</html>